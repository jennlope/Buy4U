{% extends "pages/base.html" %}
{% load static i18n l10n %}

{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="display-6 mb-1">{{ title }}</h1>
      <p class="text-muted mb-0">{{ subtitle }}</p>
    </div>

    <div class="text-end">
      <div class="d-flex gap-2 mb-2">
        <div class="input-group input-group-sm" style="width:220px">
          <span class="input-group-text bg-white"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7" stroke-width="2"></circle><line x1="21" y1="21" x2="16.65" y2="16.65" stroke-width="2"></line></svg></span>
          <input id="searchInput" class="form-control form-control-sm" placeholder="{% trans 'Search product...' %}" aria-label="{% trans 'Search' %}">
        </div>

        <div class="btn-group btn-group-sm" role="group" aria-label="{% trans 'Quick actions' %}">
          <a href="{% url 'admin_reports_overview' %}" class="btn btn-outline-success">üìä</a>
          <a href="{% url 'admin_top_products' %}" class="btn btn-outline-primary">üî•</a>
          <a href="{% url 'admin_reports_ratings' %}" class="btn btn-outline-warning">‚≠ê</a>
          <a href="{% url 'most_added_to_cart' %}" class="btn btn-outline-success" title="{% trans 'Most added to cart products' %}">üõí</a>
          <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary">üè∑Ô∏è</a>
          <a href="{% url 'admin_browsing_history_ui' %}" class="btn btn-outline-info">üîé</a>
        </div>
      </div>
      <div class="small text-muted">{% trans "Quick access to reports and administrative tools" %}</div>
    </div>
  </div>

  <!-- Agregar producto (panel compacto y moderno) -->
  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h5 mb-0">{% trans "Add product" %}</h3>
        <small class="text-muted">{% trans "Fill in the data and press" %} <strong>{% trans "Add" %}</strong></small>
      </div>

      <form method="POST" enctype="multipart/form-data" class="row g-3">
        {% csrf_token %}
        <input type="hidden" name="add" value="1">

        <div class="col-md-6">
          <label class="form-label small">{% trans "Name" %}</label>
          <input type="text" name="name" id="productName" class="form-control form-control-sm" required>
          
          <label class="form-label small mt-2">{% trans "Brand" %}</label>
          <input type="text" name="brand" id="productBrand" class="form-control form-control-sm" required>

          <label class="form-label small mt-2">{% trans "Quantity" %}</label>
          <input type="number" name="quantity" class="form-control form-control-sm" required>
        </div>

        <div class="col-md-6">
          <label class="form-label small">{% trans "Price" %}</label>
          <div class="input-group input-group-sm">
            <span class="input-group-text">$</span>
            <input type="number" name="price" id="productPrice" class="form-control form-control-sm" step="0.01" required>
            <button type="button" class="btn btn-outline-primary btn-sm" id="btnRecomendarPrecio">
              <i class="fas fa-robot"></i> {% trans "Recommend" %}
            </button>
          </div>
          <div id="precioRecomendacion" class="mt-2 d-none">
            <div class="alert alert-info alert-sm py-2 px-3">
              <strong>üí° {% trans "AI Recommendation:" %}</strong>
              <div id="precioRecomendadoTexto"></div>
            </div>
          </div>

          <label class="form-label small mt-2">{% trans "Warranty" %}</label>
          <input type="text" name="warranty" class="form-control form-control-sm">

          <label class="form-label small mt-2">{% trans "Type" %}</label>
          <input type="text" name="type" id="productType" class="form-control form-control-sm">
        </div>

        <div class="col-12">
          <label class="form-label small">{% trans "Description" %}</label>
          <textarea name="description" rows="2" class="form-control form-control-sm" required></textarea>
        </div>

        <div class="col-md-6">
          <label class="form-label small">{% trans "Image" %}</label>
          <input type="file" name="image" class="form-control form-control-sm" accept="image/*">
        </div>

        <div class="col-md-6 d-flex align-items-end justify-content-end">
          <button type="submit" class="btn btn-success btn-sm rounded-pill px-3">{% trans "Add product" %}</button>
        </div>
      </form>
    </div>
  </div>

  <div class="d-flex justify-content-end mb-3 gap-2">
    <a href="{% url 'generar_reporte' 'excel' %}" class="btn btn-outline-success btn-sm">{% trans "Download Excel" %}</a>
    <a href="{% url 'generar_reporte' 'pdf' %}" class="btn btn-outline-danger btn-sm">{% trans "Download PDF" %}</a>
  </div>

  <!-- Grid de productos -->
  <div id="productsGrid" class="row g-3">
    {% for product in products %}
    <div class="col-sm-6 col-lg-4">
      <div class="card h-100 shadow-sm rounded-4 overflow-hidden product-card">
        <div style="height:160px; background:#f8fafc; display:flex; align-items:center; justify-content:center;">
          {% if product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}" style="max-height:140px; object-fit:contain;">
          {% else %}
            <div class="text-muted text-center">{% trans "No image" %}</div>
          {% endif %}
        </div>

        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="h6 mb-0">{{ product.name }}</h5>
            <div class="text-end">
              <div class="badge bg-success text-white">${{ product.price }}</div>
            </div>
          </div>

          <p class="mb-1 text-muted small">{{ product.brand }} ‚Ä¢ {{ product.type }}</p>
          <p class="mb-2 small text-truncate" title="{{ product.description }}">{{ product.description }}</p>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
              <span class="small text-muted">{% trans "Stock" %}</span>
              <div class="fw-semibold">{{ product.quantity }}</div>
            </div>

            <div class="d-flex gap-2">
              <form method="POST" onsubmit="return confirm('{% trans 'Are you sure you want to delete this product?' %}');">
                {% csrf_token %}
                <input type="hidden" name="delete" value="{{ product.pk }}">
                <button type="submit" class="btn btn-sm btn-outline-danger">{% trans "Delete" %}</button>
              </form>

              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editProductModal{{ product.pk }}">{% trans "Edit" %}</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal edici√≥n (se mantiene igual funcionalmente) -->
    <div class="modal fade" id="editProductModal{{ product.pk }}" tabindex="-1" aria-labelledby="editProductLabel{{ product.pk }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{% trans "Edit product" %}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Close' %}"></button>
          </div>
          <div class="modal-body">
            <form method="POST" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="hidden" name="edit" value="{{ product.pk }}">

              <div class="mb-2">
                <label class="form-label small">{% trans "Name" %}</label>
                <input type="text" name="name" class="form-control form-control-sm" value="{{ product.name }}" required>
              </div>

              <div class="mb-2 row">
                <div class="col-6">
                  <label class="form-label small">{% trans "Price" %}</label>
                  <input type="number" name="price" class="form-control form-control-sm" value="{{ product.price|unlocalize }}" step="0.01" required>
                </div>
                <div class="col-6">
                  <label class="form-label small">{% trans "Quantity" %}</label>
                  <input type="number" name="quantity" class="form-control form-control-sm" value="{{ product.quantity }}" required>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label small">{% trans "Brand" %}</label>
                <input type="text" name="brand" class="form-control form-control-sm" value="{{ product.brand }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">{% trans "Warranty" %}</label>
                <input type="text" name="warranty" class="form-control form-control-sm" value="{{ product.warranty }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">{% trans "Type" %}</label>
                <input type="text" name="type" class="form-control form-control-sm" value="{{ product.type }}">
              </div>

              <div class="mb-2">
                <label class="form-label small">{% trans "Description" %}</label>
                <textarea name="description" class="form-control form-control-sm" rows="3">{{ product.description }}</textarea>
              </div>

              <div class="mb-3">
                <label class="form-label small">{% trans "Image" %}</label>
                {% if product.image %}
                  <div class="mb-2">
                    <small class="text-muted d-block mb-1">{% trans "Current image:" %}</small>
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                  </div>
                {% endif %}
                <input type="file" name="image" class="form-control form-control-sm" accept="image/*">
                {% if product.image %}
                  <small class="form-text text-muted">{% trans "Leave empty to keep current image" %}</small>
                {% endif %}
              </div>

              <div class="text-end">
                <button type="submit" class="btn btn-success btn-sm">{% trans "Save changes" %}</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
{% empty %}
    <div class="col-12">
      <div class="card p-4 rounded-4 text-center text-muted">{% trans "No products available." %}</div>
    </div>
{% endfor %}
  </div>
</div>

<style>
  .product-card { transition: transform .12s ease, box-shadow .12s ease; }
  .product-card:hover { transform: translateY(-6px); box-shadow: 0 14px 40px rgba(15,23,42,0.08); }
  .text-truncate { display:block; max-height: 3.6em; overflow: hidden; }
  .rounded-4 { border-radius: 12px; }
  .bg-light-subtle { background-color: #fbfdff; }
  .btn-outline-success.active { background-color: rgba(16,185,129,0.08); }
</style>

<script>
// B√∫squeda simple en el cliente para mejorar UX (no sustituye al filtrado en servidor)
document.getElementById('searchInput')?.addEventListener('input', function(e){
  const q = e.target.value.toLowerCase().trim();
  document.querySelectorAll('#productsGrid .product-card').forEach(card => {
    const text = card.innerText.toLowerCase();
    card.parentElement.style.display = text.includes(q) ? '' : 'none';
  });
});

// Recomendaci√≥n de precio con IA
document.getElementById('btnRecomendarPrecio')?.addEventListener('click', async function() {
  const nombre = document.getElementById('productName').value;
  const marca = document.getElementById('productBrand').value;
  const tipo = document.getElementById('productType').value;
  
  if (!nombre) {
    alert('{% trans "Please enter the product name first" %}');
    return;
  }
  
  const btn = this;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Querying..." %}';
  
  try {
    const response = await fetch('/api/ia/recomendar-precio/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ nombre, marca, tipo })
    });
    
    const data = await response.json();
    
    if (data.success) {
      const recomendacion = data.data;
      document.getElementById('productPrice').value = recomendacion.precio_recomendado.toFixed(2);
      
      document.getElementById('precioRecomendadoTexto').innerHTML = `
        <div class="small">
          <strong>{% trans "Suggested price:" %}</strong> $${recomendacion.precio_recomendado.toFixed(2)}<br>
          <strong>{% trans "Range:" %}</strong> $${recomendacion.precio_minimo.toFixed(2)} - $${recomendacion.precio_maximo.toFixed(2)}<br>
          <strong>{% trans "Confidence:" %}</strong> ${recomendacion.confianza}<br>
          <em>${recomendacion.justificacion}</em>
        </div>
      `;
      document.getElementById('precioRecomendacion').classList.remove('d-none');
    } else {
      alert('{% trans "Error:" %} ' + data.error);
    }
  } catch (err) {
    alert('{% trans "Error querying recommendation:" %} ' + err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-robot"></i> {% trans "Recommend" %}';
  }
});
</script>

{% endblock %}
