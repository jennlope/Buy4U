{% extends "pages/base.html" %}
{% load static i18n %}
{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary btn-sm">← Volver</a>
    </div>
    <div>
      <h2 class="h4 mb-1">Top productos</h2>
      <p class="text-muted mb-0">Visualiza los productos más vistos y más comprados.</p>
    </div>

    <div class="d-flex align-items-center gap-3">
      <label for="topSelect" class="me-2 text-muted small mb-0">Mostrar</label>
      <select id="topSelect" class="form-select form-select-sm rounded-pill shadow-sm" style="width:120px;">
        <option value="5">Top 5</option>
        <option value="10" selected>Top 10</option>
        <option value="20">Top 20</option>
      </select>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100">
        <div class="card-header bg-gradient text-white py-3" style="background: linear-gradient(135deg, #16a34a, #4ade80);">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold">Más vistos</h6>
            <small class="opacity-75">Últimas 24 horas</small>
          </div>
        </div>
        <div class="card-body bg-light-subtle">
          <ul id="topViewed" class="list-group list-group-flush"></ul>
          <div id="viewedEmpty" class="text-center py-3 d-none text-muted">No hay datos para mostrar.</div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100">
        <div class="card-header bg-gradient text-white py-3" style="background: linear-gradient(135deg, #2563eb, #60a5fa);">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-semibold">Más comprados</h6>
            <small class="opacity-75">Periodo configurable</small>
          </div>
        </div>
        <div class="card-body bg-light-subtle">
          <ul id="topBought" class="list-group list-group-flush"></ul>
          <div id="boughtEmpty" class="text-center py-3 d-none text-muted">No hay datos para mostrar.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4">
    <div id="lastUpdated" class="text-muted small">Última actualización: —</div>
    <div class="d-flex align-items-center gap-2">
      <div id="spinner" class="spinner-border spinner-border-sm text-primary d-none" role="status" aria-hidden="true"></div>
      <div id="errorMsg" class="text-danger small d-none"></div>
    </div>
  </div>
</div>

<style>
  .list-group-item {
    border: 0;
    background: #fff;
    border-radius: 10px;
    margin-bottom: 0.5rem;
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: all 0.2s ease;
  }
  .list-group-item:hover {
    background: #f9fafb;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }
  .rank-badge {
    width: 36px;
    height: 36px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: #f3f4f6;
    font-weight: 600;
    color: #374151;
    margin-right: 10px;
  }
  .fw-semibold.small { font-size: 0.9rem; }
  .badge {
    font-size: 0.8rem;
    padding: 0.4em 0.6em;
    border-radius: 10px;
  }
  .card-header {
    border-bottom: none;
  }
</style>

<script>
(function(){
  const select = document.getElementById('topSelect');
  const tv = document.getElementById('topViewed');
  const tb = document.getElementById('topBought');
  const spinner = document.getElementById('spinner');
  const lastUpdated = document.getElementById('lastUpdated');
  const errorMsg = document.getElementById('errorMsg');
  const viewedEmpty = document.getElementById('viewedEmpty');
  const boughtEmpty = document.getElementById('boughtEmpty');

  function showLoading(on){
    spinner.classList.toggle('d-none', !on);
    if(on){
      tv.innerHTML = ''; tb.innerHTML = '';
      for(let i=0;i<5;i++){
        const s = document.createElement('li');
        s.className = 'list-group-item';
        s.innerHTML = `<div class=\"skeleton-line w-75\"></div>`;
        tv.appendChild(s.cloneNode(true));
        tb.appendChild(s.cloneNode(true));
      }
    }
  }

  async function loadTop(){
    const n = select.value;
    showLoading(true);
    errorMsg.classList.add('d-none');

    try{
      const res = await fetch(`/admin/reports/top-products/data/?n=${encodeURIComponent(n)}`);
      if(!res.ok) throw new Error('Error en la petición');
      const data = await res.json();

      tv.innerHTML = '';
      tb.innerHTML = '';

      if(Array.isArray(data.top_viewed) && data.top_viewed.length){
        viewedEmpty.classList.add('d-none');
        data.top_viewed.forEach((item, index)=>{
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = `
            <div class='d-flex align-items-center'>
              <div class='rank-badge'>#${index+1}</div>
              <div class='fw-semibold small'>${escapeHtml(item.product)}</div>
            </div>
            <span class='badge bg-success'>${item.views || 0}</span>`;
          tv.appendChild(li);
        });
      } else viewedEmpty.classList.remove('d-none');

      if(Array.isArray(data.top_bought) && data.top_bought.length){
        boughtEmpty.classList.add('d-none');
        data.top_bought.forEach((item, index)=>{
          const li = document.createElement('li');
          li.className = 'list-group-item';
          li.innerHTML = `
            <div class='d-flex align-items-center'>
              <div class='rank-badge'>#${index+1}</div>
              <div class='fw-semibold small'>${escapeHtml(item.product)}</div>
            </div>
            <span class='badge bg-primary'>${item.qty || 0}</span>`;
          tb.appendChild(li);
        });
      } else boughtEmpty.classList.remove('d-none');

      lastUpdated.textContent = 'Última actualización: ' + new Date().toLocaleString();
    }catch(err){
      console.error(err);
      errorMsg.textContent = 'No se pudieron cargar los datos.';
      errorMsg.classList.remove('d-none');
    }finally{
      showLoading(false);
    }
  }

  function escapeHtml(str){
    if(str == null) return '';
    return String(str).replace(/[&<>"'`]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;','`':'&#96;'}[s]));
  }

  select.addEventListener('change', loadTop);
  loadTop();
})();
</script>

{% endblock %}
