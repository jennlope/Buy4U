{% extends "pages/base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-12">
            <h1 class="h1">{{ title }}</h1>
            <p>{{ subtitle }}</p>
        </div>
    </div>

    <!-- Form to search -->
    <form method="GET" class="mb-4">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                {{ form.name }}
            </div>
            <div class="col-md-2">
                {{ form.min_price }}
            </div>
            <div class="col-md-2">
                {{ form.max_price }}
            </div>
            <div class="col-md-3">
                {{ form.brand }}
            </div>
            <div class="col-md-2">
                {{ form.type }}
            </div>
            <div class="col-md-1 d-grid">
                <button type="submit" class="btn btn-success fw-bold fs-5 w-100">{% trans "Search" %}</button>
            </div>
        </div>
    </form>

    <!-- Skeleton Screens (shown while loading) -->
    <div class="row skeleton-container" id="skeletonProducts" style="display: none;">
        {% for i in "123456789012" %}
        <div class="col-md-4 col-lg-3 mb-4">
            <div class="skeleton-card">
                <div class="skeleton-image"></div>
                <div class="skeleton-body">
                    <div class="skeleton-title"></div>
                    <div class="skeleton-price"></div>
                    <div class="skeleton-button"></div>
                    <div class="skeleton-button"></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Actual Products -->
    <div class="row" id="productsContainer">
    {% for product in products %}
    <div class="col-md-4 col-lg-3 mb-4 product-card" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|divisibleby:4|yesno:'0,100' }}">
        <div class="card position-relative h-100 shadow-sm hover-lift">
            <div class="position-relative">
                <img src="{{ product.image.url }}" 
                     class="card-img-top img-fluid lazy-load" 
                     alt="{{ product.name }}"
                     loading="lazy"
                     data-src="{{ product.image.url }}">

            <!-- Si el producto estÃ¡ agotado, mostrar "SOLD OUT" -->
                {% if product.quantity == 0 %}
                <div style="position: absolute; top: 1px; left: 2px; width: 200px; opacity: 0.8;">
                    <img src="{% static 'img/sold-out.png' %}" alt="{% trans 'Sold Out' %}" style="width: 100%;">
                </div>
                {% endif %}
            </div>

            <div class="card-body text-center d-flex flex-column">
                <h5 class="card-title">{% trans product.name %}</h5>
                {% with product.price|stringformat:"0.2f" as full_price %}
                {% with full_price|cut:"." as parts %}
                    <p class="fw-bold" style="font-size: 2rem;">
                        ${{ full_price|slice:":-3" }}<sup style="font-size: 1rem;">{{ full_price|slice:"-2:" }}</sup>
                    </p>
                {% endwith %}
            {% endwith %}
            
                
                <div class="d-grid gap-2 mt-auto">
                    <a href="{% url 'product_detail' product.id %}" class="btn btn-success fw-bold fs-5 w-100">{% trans "View Details" %}</a>
                    <!-- Formulario para agregar al carrito -->
                    <form method="post" action="{% url 'add_cart' product.id %}" class="add-to-cart-form">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-primary fw-bold fs-5 w-100 add-to-cart-btn" style="background-color: #093314; border: none; color: white;" {% if product.quantity == 0 %}disabled{% endif %}>
                            <span class="btn-text">{% trans "Add to Cart" %}</span>
                            <i class="fas fa-check btn-icon" style="display: none;"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% empty %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle me-2"></i>
            {% trans "No products available." %}
        </div>
    </div>
{% endfor %}
    </div>
</div>

<style>
/* Skeleton Loading Styles */
.skeleton-card {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.skeleton-image {
    width: 100%;
    height: 250px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

.skeleton-body {
    padding: 20px;
}

.skeleton-title {
    height: 24px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    margin-bottom: 15px;
}

.skeleton-price {
    height: 32px;
    width: 60%;
    margin: 0 auto 15px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
}

.skeleton-button {
    height: 44px;
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
    margin-bottom: 10px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Hover Effects */
.hover-lift {
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.hover-lift:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

/* Add to Cart Button Animation */
.add-to-cart-btn {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
}

.add-to-cart-btn.added {
    background-color: #10b981 !important;
}

.add-to-cart-btn.added .btn-text {
    display: none;
}

.add-to-cart-btn.added .btn-icon {
    display: inline-block !important;
    animation: checkPop 0.5s ease;
}

@keyframes checkPop {
    0% {
        transform: scale(0);
        opacity: 0;
    }
    50% {
        transform: scale(1.3);
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Breadcrumb Styles */
.breadcrumb {
    background-color: #f8f9fa;
    padding: 12px 20px;
    border-radius: 8px;
}

.breadcrumb-item a {
    color: #11998e;
    text-decoration: none;
    transition: color 0.3s ease;
}

.breadcrumb-item a:hover {
    color: #0d7a70;
}

.breadcrumb-item.active {
    color: #6b7280;
}

/* Lazy Load Images */
.lazy-load {
    opacity: 0;
    transition: opacity 0.3s ease;
}

.lazy-load.loaded {
    opacity: 1;
}

/* Product Card Animation */
.product-card {
    animation: fadeInUp 0.6s ease forwards;
    opacity: 0;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Stagger animation for product cards */
.product-card:nth-child(1) { animation-delay: 0.1s; }
.product-card:nth-child(2) { animation-delay: 0.2s; }
.product-card:nth-child(3) { animation-delay: 0.3s; }
.product-card:nth-child(4) { animation-delay: 0.4s; }
.product-card:nth-child(5) { animation-delay: 0.5s; }
.product-card:nth-child(6) { animation-delay: 0.6s; }
.product-card:nth-child(7) { animation-delay: 0.7s; }
.product-card:nth-child(8) { animation-delay: 0.8s; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lazy Loading Images
    const images = document.querySelectorAll('.lazy-load');
    
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.add('loaded');
                observer.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));

    // Add to Cart Animation
    const addToCartForms = document.querySelectorAll('.add-to-cart-form');
    
    addToCartForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const button = this.querySelector('.add-to-cart-btn');
            
            if (!button.disabled) {
                button.classList.add('added');
                
                // Reset after animation
                setTimeout(() => {
                    button.classList.remove('added');
                }, 2000);
            }
        });
    });

    // Simulate skeleton loading on first visit (optional)
    // This would typically be used with AJAX loading
    /*
    const skeleton = document.getElementById('skeletonProducts');
    const products = document.getElementById('productsContainer');
    
    skeleton.style.display = 'flex';
    products.style.display = 'none';
    
    setTimeout(() => {
        skeleton.style.display = 'none';
        products.style.display = 'flex';
    }, 1500);
    */
});
</script>
{% endblock %}