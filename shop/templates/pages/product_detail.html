{% extends "pages/base.html" %}
{% load static i18n %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-lg-12">
      <h1 class="h1">{{ title }}</h1>
      <h2 class="h2">{{ subtitle }}</h2>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-6">
      <div class="position-relative">
        {% if product.image %}
          <img src="{{ product.image.url }}" class="card-img-top img-fluid" alt="{{ product.name }}">
        {% else %}
          <div class="border rounded d-flex align-items-center justify-content-center" style="height:320px;">
            <span class="text-muted">{% trans "No image available" %}</span>
          </div>
        {% endif %}

        <!-- Si el producto está agotado, mostrar "SOLD OUT" -->
        {% if product.quantity == 0 %}
        <div style="position: absolute; top: 1px; left: 2px; width: 200px; opacity: 0.8;">
          <img src="{% static 'img/sold-out.png' %}" alt="{% trans 'Sold Out' %}" style="width: 100%;">
        </div>
        {% endif %}
      </div>
    </div>

    <div class="col-md-6">
      <ul class="list-group mb-3">
        <li class="list-group-item"><strong>{% trans "Name" %}:</strong> {{ product.name }}</li>
        <li class="list-group-item"><strong>{% trans "Price" %}:</strong> ${{ product.price|floatformat:2 }}</li>
        <li class="list-group-item"><strong>{% trans "Brand" %}:</strong> {{ product.brand }}</li>
        <li class="list-group-item"><strong>{% trans "Warranty" %}:</strong> {{ product.warranty }}</li>
        <li class="list-group-item"><strong>{% trans "Quantity" %}:</strong> {{ product.quantity }}</li>
        <li class="list-group-item"><strong>{% trans "Type" %}:</strong> {{ product.type }}</li>
        <li class="list-group-item"><strong>{% trans "Description" %}:</strong> {{ product.description }}</li>
      </ul>

      <!-- Formulario para agregar al carrito -->
      <form method="post" action="{% url 'add_cart' product.id %}" class="mb-3">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary fw-bold fs-5 w-100" style="background-color: #093314; border: none; color: white;" {% if product.quantity == 0 %}disabled{% endif %}>
          <i class="fas fa-cart-plus"></i> {% trans "Add to Cart" %}
        </button>
      </form>

      <a href="#reviews" class="btn btn-outline-success fw-bold fs-5 w-100">{% trans "Read reviews" %}</a>
    </div>
  </div>
</div>

<hr class="my-5">

<!-- SECCIÓN DE RESEÑAS MEJORADA (HU19) -->
<div class="container py-4">
  <!-- Header con calificación promedio -->
  <div class="card border-0 shadow-sm rounded-4 mb-4" style="background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);">
    <div class="card-body p-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h3 class="h4 mb-2">
            <i class="fas fa-comments text-success me-2"></i>
            {% trans "Reviews" %}
          </h3>
          <p class="text-muted small mb-0">
            ({{ reviews_count }} {% trans "reviews" %})
          </p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <div class="d-inline-flex align-items-center gap-3 bg-white px-4 py-2 rounded-pill shadow-sm">
            <div>
              <div class="h2 fw-bold text-success mb-0">
                {% if avg_rating %}{{ avg_rating|floatformat:1 }}{% else %}N/A{% endif %}
              </div>
              <small class="text-muted">{% trans "de 5" %}</small>
            </div>
            <div style="font-size: 1.5rem; color: #ffc107;">
              {% for i in "12345" %}
                {% if forloop.counter <= full_stars %}
                  ★
                {% elif forloop.counter == full_stars|add:1 and has_half_star %}
                  ⯨
                {% else %}
                  <span style="color: #e5e7eb;">☆</span>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selector de orden -->
  <div class="d-flex justify-content-between align-items-center mb-3" id="reviews">
    <h5 class="h6 text-muted mb-0">{% trans "Customer opinions" %}</h5>
    <form method="get" class="d-flex align-items-center gap-2">
      <label for="sort" class="small text-muted mb-0">{% trans "Sort by" %}:</label>
      <select id="sort" name="sort" class="form-select form-select-sm rounded-pill" style="width: auto;" onchange="this.form.submit()">
        <option value="recent" {% if sort == 'recent' %}selected{% endif %}>{% trans "Most recent" %}</option>
        <option value="rating" {% if sort == 'rating' %}selected{% endif %}>{% trans "Highest rating" %}</option>
        <option value="useful" {% if sort == 'useful' %}selected{% endif %}>{% trans "Most useful" %}</option>
      </select>
    </form>
  </div>

  <!-- Lista de reseñas mejorada -->
  {% if reviews %}
    <div class="reviews-list">
      {% for r in reviews %}
        <div class="card border-0 shadow-sm rounded-4 mb-3 review-card">
          <div class="card-body p-4">
            <!-- Header de la reseña -->
            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom">
              <div class="d-flex align-items-center gap-3">
                <!-- Avatar -->
                <div class="avatar-circle">
                  {{ r.user.username|first|upper }}
                </div>
                <div>
                  <h6 class="mb-0 fw-bold">{{ r.user.username }}</h6>
                  <small class="text-muted">
                    <i class="far fa-calendar-alt me-1"></i>
                    {{ r.created_at|date:"d M Y" }}
                  </small>
                </div>
              </div>
              
              <!-- Calificación con estrellas -->
              <div style="font-size: 1.25rem; color: #ffc107;">
                {% for i in "12345" %}
                  <span {% if forloop.counter > r.rating %}style="color: #e5e7eb;"{% endif %}>★</span>
                {% endfor %}
              </div>
            </div>

            <!-- Contenido de la reseña -->
            <p class="mb-3 text-dark" style="line-height: 1.7;">{{ r.text|linebreaksbr }}</p>

            <!-- Footer con botón útil -->
            <div class="d-flex justify-content-between align-items-center pt-2">
              <div>
                {% if r.user == user %}
                  <span class="badge rounded-pill px-3 py-2" style="background-color: rgba(22, 163, 74, 0.1); color: #16a34a;">
                    <i class="fas fa-check-circle me-1"></i>
                    {% trans "Your review" %}
                  </span>
                {% endif %}
              </div>
              
              <form action="{% url 'review_useful' pk=r.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
                  <i class="far fa-thumbs-up me-1"></i>
                  {% trans "Helpful" %} 
                  {% if r.useful_count > 0 %}
                    <span class="badge bg-secondary rounded-pill ms-1">{{ r.useful_count }}</span>
                  {% endif %}
                </button>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <i class="fas fa-comment-slash text-muted opacity-25" style="font-size: 4rem;"></i>
      <p class="text-muted mt-3">{% trans "Be the first to review this product." %}</p>
    </div>
  {% endif %}

  <!-- Formulario de nueva reseña -->
  {% if can_review and review_form %}
    <div class="card border-0 shadow-sm rounded-4 mt-4">
      <div class="card-header bg-white border-0 pt-4 pb-0">
        <h5 class="h6 mb-0">
          <i class="fas fa-pen text-success me-2"></i>
          {% trans "Write your review" %}
        </h5>
      </div>
      <div class="card-body p-4">
        <form action="{% url 'product_review' id=product.id %}" method="post">
          {% csrf_token %}

          <!-- Rating con estrellas -->
          <div class="mb-3">
            <label class="form-label fw-semibold">
              <strong>{% trans "Rating" %}</strong>
            </label>
            <div class="star-rating" role="radiogroup" aria-label="{% trans 'Rate from 1 to 5' %}">
              {% for i in "54321" %}
                <input class="star-input" type="radio" name="rating" id="star{{ i }}" value="{{ i }}"
                       {% if review_form.rating.value|stringformat:"s" == i|stringformat:"s" %}checked{% endif %}>
                <label for="star{{ i }}" class="star-label" title="{{ i }} {% trans 'stars' %}" aria-label="{{ i }} {% trans 'stars' %}">★</label>
              {% endfor %}
            </div>
            <small class="text-muted">{% trans "Select from 1 to 5 stars." %}</small>
            {% for err in review_form.rating.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
          </div>

          <!-- Texto de la reseña -->
          <div class="mb-3">
            {{ review_form.text.label_tag }}
            <textarea name="{{ review_form.text.name }}" class="form-control rounded-3" rows="5" 
                      placeholder="{% trans 'Share your experience with this product...' %}" required>{{ review_form.text.value|default:'' }}</textarea>
            {% if review_form.text.help_text %}
              <div class="form-text">{{ review_form.text.help_text }}</div>
            {% endif %}
            {% for err in review_form.text.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
          </div>

          <button class="btn btn-success btn-lg rounded-pill px-4" type="submit">
            <i class="fas fa-paper-plane me-2"></i>
            {% trans "Submit review" %}
          </button>
        </form>
      </div>
    </div>
  {% else %}
    {% if user.is_authenticated %}
      <div class="alert alert-info border-0 rounded-4 mt-4 shadow-sm">
        <div class="d-flex align-items-center">
          <i class="fas fa-info-circle fs-4 me-3"></i>
          <div>
            <strong>{% trans "Want to leave a review?" %}</strong>
            <p class="mb-0 small">{% trans "You can only review products you have purchased." %}</p>
          </div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning border-0 rounded-4 mt-4 shadow-sm">
        <div class="d-flex align-items-center">
          <i class="fas fa-sign-in-alt fs-4 me-3"></i>
          <div>
            <strong>{% trans "Sign in to review" %}</strong>
            <p class="mb-0 small">{% trans "Please sign in to leave a review." %}</p>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}
</div>

<style>
/* === Estilos HU19: Reseñas mejoradas === */

/* Avatar circular */
.avatar-circle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  font-weight: 700;
  flex-shrink: 0;
  box-shadow: 0 4px 12px rgba(22, 163, 74, 0.25);
}

/* Cards de reseñas con hover */
.review-card {
  transition: all 0.3s ease;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.review-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12) !important;
}

/* Sistema de rating con estrellas */
.star-rating {
  display: inline-flex;
  flex-direction: row-reverse;
  justify-content: flex-end;
  gap: 4px;
}

.star-input {
  display: none;
}

.star-label {
  font-size: 2.5rem;
  cursor: pointer;
  color: #e5e7eb;
  transition: all 0.2s ease;
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.star-label:hover {
  transform: scale(1.1);
}

.star-input:checked ~ .star-label,
.star-label:hover,
.star-label:hover ~ .star-label {
  color: #ffc107;
}

/* Bordes redondeados */
.rounded-4 {
  border-radius: 16px !important;
}

.rounded-3 {
  border-radius: 12px !important;
}

/* Textarea mejorado */
textarea.form-control {
  resize: vertical;
  min-height: 120px;
}

textarea.form-control:focus {
  border-color: #16a34a;
  box-shadow: 0 0 0 0.25rem rgba(22, 163, 74, 0.15);
}

/* Botón con efecto */
.btn-success {
  background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
  border: none;
  box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
  transition: all 0.3s ease;
}

.btn-success:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(22, 163, 74, 0.4);
  background: linear-gradient(135deg, #15803d 0%, #16a34a 100%);
}

/* Alertas personalizadas */
.alert {
  border-left: 4px solid;
}

.alert-info {
  background-color: #f0f9ff;
  border-left-color: #0ea5e9;
  color: #0c4a6e;
}

.alert-warning {
  background-color: #fffbeb;
  border-left-color: #f59e0b;
  color: #78350f;
}

/* Responsive */
@media (max-width: 768px) {
  .avatar-circle {
    width: 45px;
    height: 45px;
    font-size: 1.1rem;
  }
  
  .star-label {
    font-size: 2rem;
  }
}
</style>

{% endblock %}