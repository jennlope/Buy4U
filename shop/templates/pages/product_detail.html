{% extends "pages/base.html" %}
{% load static i18n %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-lg-12">
      <h1 class="h1">{{ title }}</h1>
      <h2 class="h2">{{ subtitle }}</h2>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-6">
      {% if product.image %}
        <img src="{{ product.image.url }}" class="card-img-top img-fluid" alt="{{ product.name }}">
      {% else %}
        <div class="border rounded d-flex align-items-center justify-content-center" style="height:320px;">
          <span class="text-muted">{% trans "No image available" %}</span>
        </div>
      {% endif %}
    </div>

    <div class="col-md-6">
      <ul class="list-group">
        <li class="list-group-item"><strong>{% trans "Name" %}:</strong> {{ product.name }}</li>
        <li class="list-group-item"><strong>{% trans "Price" %}:</strong> ${{ product.price|floatformat:2 }}</li>
        <li class="list-group-item"><strong>{% trans "Brand" %}:</strong> {{ product.brand }}</li>
        <li class="list-group-item"><strong>{% trans "Warranty" %}:</strong> {{ product.warranty }}</li>
        <li class="list-group-item"><strong>{% trans "Quantity" %}:</strong> {{ product.quantity }}</li>
        <li class="list-group-item"><strong>{% trans "Type" %}:</strong> {{ product.type }}</li>
        <li class="list-group-item"><strong>{% trans "Description" %}:</strong> {{ product.description }}</li>
      </ul>
      <a href="#reviews" class="btn btn-success mt-3">{% trans "Read reviews" %}</a>
    </div>
  </div>
</div>

<hr>

<!-- Calificación promedio -->
<div class="container mb-3">
  <div class="d-flex align-items-center">
    <div class="me-2">
      <strong>{% trans "Average rating" %}:</strong>
      {% if avg_rating %}
        {{ avg_rating|floatformat:1 }}/5
      {% else %}
        N/A
      {% endif %}
      ({{ reviews_count }} {% trans "reviews" %})
    </div>
    <div aria-hidden="true" class="ms-3">
      {% with rounded=avg_rating|default:0|floatformat:0 %}
        {% for _ in "12345" %}
          <span class="text-warning" style="font-size:1.1rem;">
            {% if forloop.counter <= rounded %}★{% else %}☆{% endif %}
          </span>
        {% endfor %}
      {% endwith %}
    </div>
  </div>
</div>

<div class="container" id="reviews">
  <h3 class="h5 text-success">{% trans "Reviews" %}</h3>

  {% if reviews %}
    <ul class="list-group mb-3">
      {% for r in reviews %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <strong>{{ r.user.username }}</strong>
            <small class="text-muted">{{ r.created_at|date:"Y-m-d H:i" }}</small>
          </div>
          <div class="mb-1" aria-label="{% blocktrans %}Rating {{ r.rating }} of 5{% endblocktrans %}">
            {% for _ in "12345" %}
              <span class="text-warning">{% if forloop.counter <= r.rating %}★{% else %}☆{% endif %}</span>
            {% endfor %}
            <span class="ms-1 small text-muted">({{ r.rating }}/5)</span>
          </div>
          <div>{{ r.text|linebreaksbr }}</div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted">{% trans "Be the first to review this product." %}</p>
  {% endif %}

  {% if can_review and review_form %}
    <form action="{% url 'product_review' id=product.id %}" method="post" class="card card-body border-success-subtle">
      {% csrf_token %}

      <!-- Widget de estrellas accesible -->
        <div class="mb-2">
            <label class="form-label"><strong>Calificación</strong></label>
            <div class="star-group" role="radiogroup" aria-label="Califica de 1 a 5">
                {# iteramos 5 veces; revcounter dará 5,4,3,2,1 #}
                {% for _ in "12345" %}
                {% with val=forloop.revcounter %}
                    <input class="btn-check" type="radio" name="rating" id="star{{ val }}" value="{{ val }}"
                        {% if review_form.rating.value == val %}checked{% endif %}>
                    <label for="star{{ val }}" class="star-label" title="{{ val }} estrellas" aria-label="{{ val }} estrellas">★</label>
                {% endwith %}
                {% endfor %}
            </div>
            <div class="form-text">Selecciona de 1 a 5 estrellas.</div>
            {% for err in review_form.rating.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
        </div>

        <div class="form-text">{% trans "Select from 1 to 5 stars." %}</div>
        {% for err in review_form.rating.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>

      <div class="mb-2">
        {{ review_form.text.label_tag }}
        {{ review_form.text }}
        {% if review_form.text.help_text %}
          <div class="form-text">{{ review_form.text.help_text }}</div>
        {% endif %}
        {% for err in review_form.text.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>

      <button class="btn btn-success" type="submit">{% trans "Submit review" %}</button>
    </form>

    <style>
      /* Estrellas en tono verde Bootstrap */
      .star-group { direction: rtl; unicode-bidi: bidi-override; }
      .star-label {
        font-size: 1.6rem; cursor: pointer; color: #ced4da; padding: 0 .15rem;
      }
      .btn-check:checked + .star-label,
      .star-label:hover,
      .star-label:hover ~ .star-label { color: #198754; }
      .star-group:hover .btn-check:checked + .star-label { color: #ced4da; }
      .star-group:hover .star-label:hover,
      .star-group:hover .star-label:hover ~ .star-label { color: #198754; }
    </style>

  {% else %}
    {% if user.is_authenticated %}
      <div class="alert alert-warning mt-2">
        {% trans "You can only review products you have purchased." %}
      </div>
    {% else %}
      <div class="alert alert-info mt-2">
        {% trans "Please sign in to leave a review." %}
      </div>
    {% endif %}
  {% endif %}
</div>
{% endblock %}
