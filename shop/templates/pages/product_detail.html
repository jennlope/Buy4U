{% extends "pages/base.html" %}
{% load static i18n %}

{% block content %}
<div class="container py-5">
  <div class="row">
    <div class="col-lg-12">
      <h1 class="h1">{{ title }}</h1>
      <h2 class="h2">{{ subtitle }}</h2>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-6">
      <div class="position-relative">
        {% if product.image %}
          <img src="{{ product.image.url }}" class="card-img-top img-fluid" alt="{{ product.name }}">
        {% else %}
          <div class="border rounded d-flex align-items-center justify-content-center" style="height:320px;">
            <span class="text-muted">{% trans "No image available" %}</span>
          </div>
        {% endif %}

        <!-- Si el producto está agotado, mostrar "SOLD OUT" -->
        {% if product.quantity == 0 %}
        <div style="position: absolute; top: 1px; left: 2px; width: 200px; opacity: 0.8;">
          <img src="{% static 'img/sold-out.png' %}" alt="{% trans 'Sold Out' %}" style="width: 100%;">
        </div>
        {% endif %}
      </div>
    </div>

    <div class="col-md-6">
      <ul class="list-group mb-3">
        <li class="list-group-item"><strong>{% trans "Name" %}:</strong> {{ product.name }}</li>
        <li class="list-group-item"><strong>{% trans "Price" %}:</strong> ${{ product.price|floatformat:2 }}</li>
        <li class="list-group-item"><strong>{% trans "Brand" %}:</strong> {{ product.brand }}</li>
        <li class="list-group-item"><strong>{% trans "Warranty" %}:</strong> {{ product.warranty }}</li>
        <li class="list-group-item"><strong>{% trans "Quantity" %}:</strong> {{ product.quantity }}</li>
        <li class="list-group-item"><strong>{% trans "Type" %}:</strong> {{ product.type }}</li>
        <li class="list-group-item"><strong>{% trans "Description" %}:</strong> {{ product.description }}</li>
      </ul>

      <!-- Formulario para agregar al carrito -->
      <form method="post" action="{% url 'add_cart' product.id %}" class="mb-3">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary fw-bold fs-5 w-100" style="background-color: #093314; border: none; color: white;" {% if product.quantity == 0 %}disabled{% endif %}>
          <i class="fas fa-cart-plus"></i> {% trans "Add to Cart" %}
        </button>
      </form>

      <a href="#reviews" class="btn btn-outline-success fw-bold fs-5 w-100">{% trans "Read reviews" %}</a>
    </div>
  </div>
</div>

<hr>

<!-- Calificación promedio + número de reseñas -->
<div class="container mb-3">
  <div class="d-flex align-items-center">
    <span class="badge bg-success-subtle text-success border border-success-subtle me-2">
      {% if avg_rating %}{{ avg_rating|floatformat:1 }}{% else %}N/A{% endif %}/5
    </span>

    <div aria-hidden="true" class="me-2">
      <!-- Estrellas completas -->
      {% for i in "12345" %}
        {% if forloop.counter <= full_stars %}
          <span style="font-size:1.5rem; color:#ffc107;">★</span>
        {% elif forloop.counter == full_stars|add:1 and has_half_star %}
          <span style="font-size:1.5rem; color:#ffc107;">⯨</span>
        {% else %}
          <span style="font-size:1.5rem; color:#ddd;">☆</span>
        {% endif %}
      {% endfor %}
    </div>

    <small class="text-muted">
      ({{ reviews_count }} {% trans "reviews" %})
    </small>
  </div>
</div>

<!-- Cabecera reseñas + selector de orden -->
<div class="container d-flex justify-content-between align-items-center mb-2" id="reviews">
  <h3 class="h5 text-success mb-0">{% trans "Reviews" %}</h3>
  <form method="get" class="d-flex align-items-center">
    <label for="sort" class="me-2 small text-muted">{% trans "Sort by" %}:</label>
    <select id="sort" name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
      <option value="recent" {% if sort == 'recent' %}selected{% endif %}>{% trans "Most recent" %}</option>
      <option value="rating" {% if sort == 'rating' %}selected{% endif %}>{% trans "Highest rating" %}</option>
      <option value="useful" {% if sort == 'useful' %}selected{% endif %}>{% trans "Most useful" %}</option>
    </select>
  </form>
</div>

<!-- Lista de reseñas -->
<div class="container">
  {% if reviews %}
    <ul class="list-group mb-3">
      {% for r in reviews %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>{{ r.user.username }}</strong>
              <span class="ms-2 small text-muted">({{ r.rating }}/5)</span>
            </div>
            <small class="text-muted">{{ r.created_at|date:"Y-m-d H:i" }}</small>
          </div>

          <div class="mb-1" aria-label="{% blocktrans %}Rating {{ r.rating }} of 5{% endblocktrans %}">
            {% for i in "12345" %}
              <span style="font-size:1.2rem; color: {% if forloop.counter <= r.rating %}#ffc107{% else %}#ddd{% endif %};">
                ★
              </span>
            {% endfor %}
          </div>

          <div class="mb-2">{{ r.text|linebreaksbr }}</div>

          <!-- Botón "Helpful" -->
          <form action="{% url 'review_useful' pk=r.id %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-success btn-sm">
              {% trans "Helpful" %} ({{ r.useful_count }})
            </button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted">{% trans "Be the first to review this product." %}</p>
  {% endif %}

  <!-- Formulario para crear reseña (solo si puede) -->
  {% if can_review and review_form %}
    <form action="{% url 'product_review' id=product.id %}" method="post" class="card card-body border-success-subtle">
      {% csrf_token %}

      <!-- Estrellas -->
      <div class="mb-2">
        <label class="form-label"><strong>{% trans "Rating" %}</strong></label>
        <div class="star-rating" role="radiogroup" aria-label="{% trans 'Rate from 1 to 5' %}">
          {% for i in "54321" %}
            <input class="star-input" type="radio" name="rating" id="star{{ i }}" value="{{ i }}"
                   {% if review_form.rating.value|stringformat:"s" == i|stringformat:"s" %}checked{% endif %}>
            <label for="star{{ i }}" class="star-label" title="{{ i }} {% trans 'stars' %}" aria-label="{{ i }} {% trans 'stars' %}">★</label>
          {% endfor %}
        </div>
        <div class="form-text">{% trans "Select from 1 to 5 stars." %}</div>
        {% for err in review_form.rating.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>

      <div class="mb-2">
        {{ review_form.text.label_tag }}
        {{ review_form.text }}
        {% if review_form.text.help_text %}
          <div class="form-text">{{ review_form.text.help_text }}</div>
        {% endif %}
        {% for err in review_form.text.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
      </div>

      <button class="btn btn-success" type="submit">{% trans "Submit review" %}</button>
    </form>

    <style>
      .star-rating {
        display: inline-flex;
        flex-direction: row-reverse;
        justify-content: flex-end;
      }
      
      .star-input {
        display: none;
      }
      
      .star-label {
        font-size: 2rem;
        cursor: pointer;
        color: #ddd;
        transition: color 0.2s;
      }
      
      .star-input:checked ~ .star-label,
      .star-label:hover,
      .star-label:hover ~ .star-label {
        color: #ffc107;
      }
    </style>
  {% else %}
    {% if user.is_authenticated %}
      <div class="alert alert-warning mt-2">
        {% trans "You can only review products you have purchased." %}
      </div>
    {% else %}
      <div class="alert alert-info mt-2">
        {% trans "Please sign in to leave a review." %}
      </div>
    {% endif %}
  {% endif %}
</div>

{% endblock %}